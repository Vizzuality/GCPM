select
events.id as event,
events.title as title,
countries.country_name as location_name,
'{"type":"point","coordinates":[' || events.latitude || ',' || events.longitude || ']}' as centroid,
countries.country_iso_3 as iso,
countries.id as location_id,
'point' as type
from events
inner join countries on events.country = countries.country_name
where 1=1
<% if @params[:countries] %>
  and countries.id in         <%= "#{'(' + @params[:countries].join(',') + ')'}" %>
<% end %>
<% if @params[:regions] %>
  and countries.region_iso in <%= @params[:regions].to_s.gsub('[', '(').gsub(']',')').gsub('"',"'") %>
<% end %>
<% if @params[:start_date] %>
  and (events.start_date > date(<%= quote @params[:start_date] %>))
<% end %>
<% if @params[:end_date] %>
  and (events.end_date < date(<%= quote @params[:end_date] %>))
<% end %>
group by event, title, location_name, location_id, centroid, iso
